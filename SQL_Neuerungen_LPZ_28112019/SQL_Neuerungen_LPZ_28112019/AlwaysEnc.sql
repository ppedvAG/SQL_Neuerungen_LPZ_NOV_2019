--Verschlüsselter Transportweg , veschlüsselt für Unbefugte
--Zertifikat im lokalen Beutzerspeicher

create database AlwaysEnC
GO

USE AlwaysEnc
GO

CREATE COLUMN MASTER KEY [MasterKey]
WITH
(
	KEY_STORE_PROVIDER_NAME = N'MSSQL_CERTIFICATE_STORE',
	KEY_PATH = N'LocalMachine/My/4F71C697CAF19665FDAAE6A0F7A9079E9BE8EC8B'
)
GO


USE [AlwaysEnC]
CREATE COLUMN ENCRYPTION KEY [ColumnKey]
WITH VALUES
(
	COLUMN_MASTER_KEY = [MasterKey],
	ALGORITHM = 'RSA_OAEP',
	ENCRYPTED_VALUE = 0x01700000016C006F00630061006C006D0061006300680069006E0065002F006D0079002F00340066003700310063003600390037006300610066003100390036003600350066006400610061006500360061003000660037006100390030003700390065003900620065003800650063003800620049AC103F237A63346804A7067980F3CDFFFE22574118CBDDEBACE052407C31CE2B8884F9EA06F30092CA22AB27E80CE03893390A409FE8F5C30956929C29BF751C94451842A377F57CCE105405F619ACA328041D047DDB82A9B5B20EBAEB4BFC63EC493A51DF79A3871ED133DE2E90C5AAB6F979C3B8A684378E0AE870F31559F362F984FD5E7C557BD7E81949B391CCD92FBE4B9259E690D55E5DEC6F3043CF6083C049A2247B2D173CE1B1585A42FB669F0F68A3FD1787928F736A50A4BA2F68B11263149FE9392B5C7E47BFB26DEEEF33F245058719A0A3DC1CA185EB3818E6F53E32EA14195EE243380E747E763687D328E3214E314A4F235B142871DD7E70B67A90117DD7958AF119F99E8754B7134B4ACD46937045865255653FB5764F9E9063BBBDA20B224E8AD8BFA1519BCB8528CEA121A35E5577C2360F3DFB431B62056D7E4397D969D71D1DF78EBA3400029CEBB77A070C7AA2F4FC3E1099A6D7E52381C608D4F610BAA53E89E7B8BFEB9EB543025C9AA0C908E65029AB6BDC2201CFC2B71A5D6890EC374A8C447D031A7802CCE9E119080CE09155305AAB68B5F86A51938EE06833868FFC6F0D6093233BB4A3EC263D6AB6343DF97D7F8D9AB982596E96C4DCD60C8712029752EA8CB6CAEF7947357A90F9866770B81245BBE27A396149282D3930404D5F615AD82ADBF44307E697563A3D2726AFCD225E8376
)
GO

CREATE TABLE dbo.EncryptedTable
(
  ID INT IDENTITY(1,1) PRIMARY KEY,
  
  LastName NVARCHAR(32) COLLATE Latin1_General_BIN2 
    ENCRYPTED WITH 
    (
       ENCRYPTION_TYPE = DETERMINISTIC, 
       ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
       COLUMN_ENCRYPTION_KEY = ColumnKey
    ) NOT NULL,
    
  Salary INT 
    ENCRYPTED WITH 
    (
       ENCRYPTION_TYPE = RANDOMIZED, 
       ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
       COLUMN_ENCRYPTION_KEY = ColumnKey
    ) NOT NULL
);
GO

CREATE PROCEDURE dbo.AddPerson
  @LastName NVARCHAR(32),
  @Salary   INT
AS
BEGIN
  INSERT dbo.EncryptedTable(LastName,Salary) SELECT @LastName, @Salary;
END
GO

CREATE PROCEDURE dbo.GetPeopleByLastName
  @LastName NVARCHAR(32) 
AS
BEGIN
  SELECT ID, LastName, Salary
  FROM dbo.EncryptedTable
  WHERE LastName = @LastName COLLATE Latin1_General_BIN2;
END
GO

--ERROR
INSERT dbo.EncryptedTable(LastName,Salary) SELECT N'Bertrand',720000;

--ERROR
DECLARE @LastName NVARCHAR(32) = N'Bertrand', @Salary INT = 720000;
INSERT dbo.EncryptedTable(LastName,Salary) SELECT @LastName, @Salary;


--ERROR
DECLARE @LastName NVARCHAR(32) = N'Bertrand', @Salary INT = 720000;
EXEC dbo.AddPerson @LastName, @Salary;

select * from EncryptedTable

-- SSMS  Column Encryption Setting = Enabled